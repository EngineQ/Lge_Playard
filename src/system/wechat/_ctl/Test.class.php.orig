<?php
if (!defined('PhpMe')) {
	exit('Include Permission Denied!');
}

class Controller_Test extends BaseControllerDefault
{
    
    /**
     * 首页.
     */
    public function index()
    {
        print_r($this->_session);

    }

    public function cardid()
    {
        for ($i = 0; $i < 10; ++$i) {
            $id = Module_UserCard::instance()->makeUniqueId(10, 'PR');
            var_dump($id);
        }
    }

    public function xml()
    {
        $xml = '<?xml version="1.0" encoding="utf-8"?><string xmlns="http://tempuri.org/">-3951697014509332687</string>';
        $result = Lib_XmlParser::xml2Array($xml);
        print_r($result);

    }

    public function sms()
    {
        $mobiles = array('15928008612');
        $message = '短信测试：'.rand(0, 99999);
        $result  = Module_Sms_Monternet::instance()->send($mobiles, $message);
    }

    /**
     * 微信支付订单.
     */
    public function weixinOrder()
    {
        $config    = Config::get();
        $weChat    = $config['WeChat'];
        $orderNo   = str_replace('.', '', microtime(true)).rand(0, 9).rand(0, 9);
        $totalFee  = 100;
        $timestamp = time();
        $openid    = 'oSQo3uHPeoFM8vOdnh0VVGSoL8f4';
        $params    = array(
            'appid'             => $weChat['appid'],
            'mch_id'            => $weChat['mch_id'],
            'device_info'       => 'WEB',
            'nonce_str'         => Module_WeChat_Api::Instance()->makeNonceStr(),
            'body'              => '保险描述信息',
            'detail'            => '保险详细介绍信息',
            'attach'            => '家快保保险',
            'out_trade_no'      => $orderNo,
            'fee_type'          => 'CNY',
            'total_fee'         => $totalFee,
            'spbill_create_ip'  => Lib_IpHandler::getServerIp(),
            'time_start'        => date('YmdHis', $timestamp),
            'time_expire'       => date('YmdHis', $timestamp + 86400),
            //'goods_tag'         => null,
            'notify_url'        => Lib_Redirecter::getCurrentUrlWithoutUri().'pay/callback',
            'trade_type'        => 'JSAPI',
            //'product_id'        => null,
            //'limit_pay'         => null,
            'openid'            => $openid,
        );
        $params['sign'] = Module_WeChat_Api::Instance()->makeSignature($params);
        $result         = Module_WeChat_Api::Instance()->createOrder($params);
        print_r($result);
    }

    /**
     * 构造出险模拟数据.
     */
    public function serviceData()
    {
        $list = array();
        for($i = 0; $i < 100; $i++) {
            $list[] = array(
                'uid'      => $this->_session['user']['uid'],
                'order_id' => 2,
                'card_id'  => 'HS11111111',
                'content'  => '',
                'create_time'  => time(),
                'update_time'  => time(),
            );
        }
        Instance::table('product_order_service')->batchInsert($list);
    }

    public function menu()
    {
        $menuStr = <<<MM
{
     "button":[
          {
              "name":"我的家保",
              "sub_button":[
                   {
                       "type":"view",
                       "name":"注册",
                       "url":"http://picc.scjtcl.cn/"
                   },
                   {
                       "type":"view",
                       "name":"我的订单",
                       "url":"http://picc.scjtcl.cn/"
                   },
                   {
                       "type":"view",
                       "name":"我的资料",
                       "url":"http://picc.scjtcl.cn/"
                   },
                   {
                       "type":"view",
                       "name":"联系我们",
                       "url":"http://picc.scjtcl.cn/"
                   }
              ]
          },
          {
               "type":"view",
               "name":"购买产品",
               "url":"http://picc.scjtcl.cn/"
          },
          {
              "name":"关于家保",
              "sub_button":[
                   {
                       "type":"view",
                       "name":"介绍",
                       "url":"http://picc.scjtcl.cn/"
                   },
                   {
                       "type":"view",
                       "name":"受理服务",
                       "url":"http://picc.scjtcl.cn/"
                   },
                   {
                       "type":"view",
                       "name":"受理热线",
                       "url":"http://picc.scjtcl.cn/"
                   }
              ]
          }
      ]
 }
MM;
        $result = Module_WeChat_Api::Instance()->createMenu($menuStr);
        var_dump($result);
    }
}